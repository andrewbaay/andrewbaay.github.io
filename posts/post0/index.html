<!doctype html><html lang=en><head><title>Source Engine Cascaded Shadow Implementation :: Sears's sucky shaders</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="//========================================================================================== // Give shader CSM data //========================================================================================== void AGS_SetupCascadedShadowPixelShaderConstants(CBaseVSShader* pShader, IShaderDynamicAPI* pShaderAPI, int constantRegister) { // This must be consistent with what we have on ags_globallight_ps2_3_x.h! 	// CSM + Snapshot takes 13 constant registers after initial 	int initial = constantRegister; CSMData_t csmData = AGS_GetRenderState()-&amp;gt;csmData; CSMStaticData_t staticShadowData = AGS_GetRenderState()-&amp;gt;csmStaticData; ITexture* pCascadedDepthTexture = NULL; ITexture* pStaticDepthTexture = NULL; ITexture* pCloudsTexture = NULL; pCascadedDepthTexture = csmData.m_depthTexture; pStaticDepthTexture = staticShadowData.m_depthTexture; // Light forward vector + cloud shadow trigger on alpha 	Vector csmFwd = AGS_GetRenderState()-&amp;gt;m_vSunPos; pShaderAPI-&amp;gt;SetPixelShaderConstant(initial, csmFwd."><meta name=keywords content=","><meta name=robots content="noodp"><link rel=canonical href=/posts/post0/><link rel=stylesheet href=/assets/style.css><link rel=apple-touch-icon href=/img/apple-touch-icon-192x192.png><link rel="shortcut icon" href=/img/favicon/orange.png><meta name=twitter:card content="summary"><meta name=twitter:site content><meta name=twitter:creator content="baayandrew"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Source Engine Cascaded Shadow Implementation"><meta property="og:description" content="//========================================================================================== // Give shader CSM data //========================================================================================== void AGS_SetupCascadedShadowPixelShaderConstants(CBaseVSShader* pShader, IShaderDynamicAPI* pShaderAPI, int constantRegister) { // This must be consistent with what we have on ags_globallight_ps2_3_x.h! 	// CSM + Snapshot takes 13 constant registers after initial 	int initial = constantRegister; CSMData_t csmData = AGS_GetRenderState()-&amp;gt;csmData; CSMStaticData_t staticShadowData = AGS_GetRenderState()-&amp;gt;csmStaticData; ITexture* pCascadedDepthTexture = NULL; ITexture* pStaticDepthTexture = NULL; ITexture* pCloudsTexture = NULL; pCascadedDepthTexture = csmData.m_depthTexture; pStaticDepthTexture = staticShadowData.m_depthTexture; // Light forward vector + cloud shadow trigger on alpha 	Vector csmFwd = AGS_GetRenderState()-&amp;gt;m_vSunPos; pShaderAPI-&amp;gt;SetPixelShaderConstant(initial, csmFwd."><meta property="og:url" content="/posts/post0/"><meta property="og:site_name" content="Sears's sucky shaders"><meta property="og:image" content="/"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2021-04-29 15:43:47 +0800 +0800"></head><body class=orange><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>Sears's sucky shaders</div></a></div><div class=menu-trigger>menu</div></div><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about>About</a></li><li><a href=/showcase>Showcase</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about>About</a></li><li><a href=/showcase>Showcase</a></li></ul></nav></header><div class=content><div class=post><h1 class=post-title><a href=/posts/post0/>Source Engine Cascaded Shadow Implementation</a></h1><div class=post-meta><span class=post-date>2021-04-29 [Updated: 2021-04-29]</span></div><span class=post-tags>#<a href=/tags/graphics/>graphics</a>&nbsp;
#<a href=/tags/source-engine/>source engine</a>&nbsp;</span><div class=post-content><div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp>
<span style=color:#75715e>//==========================================================================================
</span><span style=color:#75715e>// Give shader CSM data
</span><span style=color:#75715e>//==========================================================================================
</span><span style=color:#75715e></span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>AGS_SetupCascadedShadowPixelShaderConstants</span>(CBaseVSShader<span style=color:#f92672>*</span> pShader, IShaderDynamicAPI<span style=color:#f92672>*</span> pShaderAPI, <span style=color:#66d9ef>int</span> constantRegister)
{
	<span style=color:#75715e>// This must be consistent with what we have on ags_globallight_ps2_3_x.h!
</span><span style=color:#75715e></span>	<span style=color:#75715e>// CSM + Snapshot takes 13 constant registers after initial
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>int</span> initial <span style=color:#f92672>=</span> constantRegister;

	CSMData_t csmData <span style=color:#f92672>=</span> AGS_GetRenderState()<span style=color:#f92672>-&gt;</span>csmData;
	CSMStaticData_t staticShadowData <span style=color:#f92672>=</span> AGS_GetRenderState()<span style=color:#f92672>-&gt;</span>csmStaticData;

	ITexture<span style=color:#f92672>*</span> pCascadedDepthTexture <span style=color:#f92672>=</span> NULL;
	ITexture<span style=color:#f92672>*</span> pStaticDepthTexture <span style=color:#f92672>=</span> NULL;
	ITexture<span style=color:#f92672>*</span> pCloudsTexture <span style=color:#f92672>=</span> NULL;

	pCascadedDepthTexture <span style=color:#f92672>=</span> csmData.m_depthTexture;
	pStaticDepthTexture <span style=color:#f92672>=</span> staticShadowData.m_depthTexture;

	<span style=color:#75715e>// Light forward vector + cloud shadow trigger on alpha
</span><span style=color:#75715e></span>	Vector csmFwd <span style=color:#f92672>=</span> AGS_GetRenderState()<span style=color:#f92672>-&gt;</span>m_vSunPos;
	pShaderAPI<span style=color:#f92672>-&gt;</span>SetPixelShaderConstant(initial, csmFwd.Base());

	<span style=color:#75715e>// Light Color
</span><span style=color:#75715e></span>	Vector4D csmLight <span style=color:#f92672>=</span> AGS_GetRenderState()<span style=color:#f92672>-&gt;</span>m_vSunColor;
	pShaderAPI<span style=color:#f92672>-&gt;</span>SetPixelShaderConstant(initial <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, csmLight.Base());

	<span style=color:#66d9ef>if</span> (pCascadedDepthTexture)
	{
		<span style=color:#75715e>// Cascaded Depth
</span><span style=color:#75715e></span>		pCascadedDepthTexture <span style=color:#f92672>=</span> csmData.m_depthTexture;
		pShader<span style=color:#f92672>-&gt;</span>BindTexture(SAMPLER_CASCADED_SHADOW, pCascadedDepthTexture, <span style=color:#ae81ff>0</span>);

		<span style=color:#75715e>//Far cascade step data
</span><span style=color:#75715e></span>		<span style=color:#66d9ef>const</span> Vector vecCascadedStep <span style=color:#f92672>=</span> csmData.vecCascadedStep;
		<span style=color:#66d9ef>float</span> vCascadedStep[<span style=color:#ae81ff>3</span>] <span style=color:#f92672>=</span> { XYZ(vecCascadedStep) };
		pShaderAPI<span style=color:#f92672>-&gt;</span>SetPixelShaderConstant(initial <span style=color:#f92672>+</span> <span style=color:#ae81ff>2</span>, vCascadedStep);

		<span style=color:#75715e>//Biasing
</span><span style=color:#75715e></span>		<span style=color:#66d9ef>float</span> biasVar[<span style=color:#ae81ff>2</span>] <span style=color:#f92672>=</span> { <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span> };
		pShaderAPI<span style=color:#f92672>-&gt;</span>SetPixelShaderConstant(initial <span style=color:#f92672>+</span> <span style=color:#ae81ff>3</span>, biasVar);

		<span style=color:#75715e>// Cascaded World To Texture
</span><span style=color:#75715e></span>		VMatrix<span style=color:#f92672>*</span> worldToTexture0 <span style=color:#f92672>=</span> csmData.m_worldToTextureMatrix;
		pShaderAPI<span style=color:#f92672>-&gt;</span>SetPixelShaderConstant(initial <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span>, worldToTexture0<span style=color:#f92672>-&gt;</span>Base(), <span style=color:#ae81ff>4</span>); <span style=color:#75715e>// up to 44
</span><span style=color:#75715e></span>
		<span style=color:#75715e>// Cascaded Filter Size
</span><span style=color:#75715e></span>		<span style=color:#66d9ef>float</span> csmShadowTweaks[<span style=color:#ae81ff>4</span>];
		csmShadowTweaks[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>=</span> pCascadedDepthTexture<span style=color:#f92672>-&gt;</span>GetActualWidth() <span style=color:#f92672>*</span> r_csm_filterscale.GetFloat();
		csmShadowTweaks[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>=</span> pCascadedDepthTexture<span style=color:#f92672>-&gt;</span>GetActualHeight() <span style=color:#f92672>*</span> r_csm_filterscale.GetFloat();
		csmShadowTweaks[<span style=color:#ae81ff>2</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
		pShaderAPI<span style=color:#f92672>-&gt;</span>SetPixelShaderConstant(initial <span style=color:#f92672>+</span> <span style=color:#ae81ff>8</span>, csmShadowTweaks);
	}
	<span style=color:#66d9ef>else</span>
	{
		pShaderAPI<span style=color:#f92672>-&gt;</span>BindStandardTexture(SAMPLER_CASCADED_SHADOW, TEXTURE_WHITE);
	}
	<span style=color:#66d9ef>if</span> (pStaticDepthTexture)
	{
		<span style=color:#75715e>// Static Depth
</span><span style=color:#75715e></span>		pStaticDepthTexture <span style=color:#f92672>=</span> staticShadowData.m_depthTexture;
		pShader<span style=color:#f92672>-&gt;</span>BindTexture(SAMPLER_STATIC_SHADOW, pStaticDepthTexture, <span style=color:#ae81ff>0</span>);

		<span style=color:#75715e>// Static World To Texture
</span><span style=color:#75715e></span>		VMatrix<span style=color:#f92672>*</span> worldToTexture1 <span style=color:#f92672>=</span> staticShadowData.m_worldToTextureMatrix;
		pShaderAPI<span style=color:#f92672>-&gt;</span>SetPixelShaderConstant(initial <span style=color:#f92672>+</span> <span style=color:#ae81ff>9</span>, worldToTexture1<span style=color:#f92672>-&gt;</span>Base(), <span style=color:#ae81ff>4</span>); <span style=color:#75715e>// up to 44
</span><span style=color:#75715e></span>
		<span style=color:#75715e>// Snapshot Filter Size
</span><span style=color:#75715e></span>		<span style=color:#66d9ef>float</span> csmStaticShadowTweaks[<span style=color:#ae81ff>4</span>];
		csmStaticShadowTweaks[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>=</span> pStaticDepthTexture<span style=color:#f92672>-&gt;</span>GetActualWidth() <span style=color:#f92672>*</span> r_csm_filterscale.GetFloat();
		csmStaticShadowTweaks[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>=</span> pStaticDepthTexture<span style=color:#f92672>-&gt;</span>GetActualHeight() <span style=color:#f92672>*</span> r_csm_filterscale.GetFloat();
		csmStaticShadowTweaks[<span style=color:#ae81ff>2</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
		pShaderAPI<span style=color:#f92672>-&gt;</span>SetPixelShaderConstant(initial <span style=color:#f92672>+</span> <span style=color:#ae81ff>13</span>, csmStaticShadowTweaks);
	}
	<span style=color:#66d9ef>else</span>
	{
		pShaderAPI<span style=color:#f92672>-&gt;</span>BindStandardTexture(SAMPLER_STATIC_SHADOW, TEXTURE_WHITE);
	}

	pCloudsTexture <span style=color:#f92672>=</span> AGS_GetRenderState()<span style=color:#f92672>-&gt;</span>cloudShadow;
	<span style=color:#75715e>// Setting up framebuffer spec map
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> (pCloudsTexture <span style=color:#f92672>&amp;&amp;</span> AGS_GetRenderState()<span style=color:#f92672>-&gt;</span>m_bCloudShadowEnabled)
	{
		pShader<span style=color:#f92672>-&gt;</span>BindTexture(SAMPLER_CLOUDS_SHADOW, pCloudsTexture, <span style=color:#ae81ff>0</span>);
	}
	<span style=color:#66d9ef>else</span>
	{
		pShaderAPI<span style=color:#f92672>-&gt;</span>BindStandardTexture(SAMPLER_CLOUDS_SHADOW, TEXTURE_WHITE);
	}
	<span style=color:#75715e>// Snapshot Depth
</span><span style=color:#75715e></span>}
</code></pre></div></div></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2021 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=/assets/main.js></script><script src=/assets/prism.js></script></div></body></html>